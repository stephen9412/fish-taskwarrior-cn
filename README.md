# taskwarrior.fish-cn-parser

對應 [GothenburgBitFactory-taskwarrior](https://github.com/GothenburgBitFactory/libshared) 的日期轉換

## 語法規則

### 基本原則
- **每個數字後面必須有單位**
- 不支援語義不明確的表達式，遇到時直接返回原文
  - 例如：`三月二十` (缺少單位)
  - 例如：`十點二十七` (缺少分鐘單位)

### 特殊規則
- **周/禮拜/星期 + 數字 = 天數**（這是 feature）
  - 例如：`這週三十` → `sow+29d`（三十表示 30 天）
  - 例如：`星期三十` → `sow+29d`
  - 單位在前面（周/禮拜/星期），後面接的數字代表天數

- **語義不明確但可接受的表達**
  - 例如：`今年三月八點` → `soy+2m+8h`
  - 雖然語義不明確（是三月某天八點？還是三月加八小時？）
  - 但用打 patch 的方式處理：今年 + 三月 + 八點

## 實作方法

### 處理流程

1. **中文數字轉換**
   - 使用 `cn2int` fish function 把中文數字轉換成阿拉伯數字
   - 例如：`三` → `3`、`十八` → `18`、`一百零八` → `108`

2. **規則打 patch**
   - 識別關鍵詞，轉換成對應的 base
     - `今年` → `soy`
     - `明年` → `sony`
     - `去年` → `sopy`
     - `這個月` → `som`
     - `下個月` → `sonm`
     - `上個月` → `sopm`
     - 等等...

3. **單位處理**
   檢測到單位後，將數字轉換成對應的偏移量：
   - `8月` → `+7m`（檢測到「月」，8-1=7）
   - `15號` → `+14d`（檢測到「號」，15-1=14）
   - `9點` → `+9h`（檢測到「點」）
   - `30分` → `+30min`（檢測到「分」）
   - `45秒` → `+45s`（檢測到「秒」）

4. **前後單位特殊處理**
   - 「前」和「後」需要獨立處理
   - 格式：`數字 + 單位 + 前/後`
     - `三年前` → `now-3y`
     - `三年後` → `now+3y`
     - `五天前` → `now-5d`
     - `十小時後` → `now+10h`
     - `三十分鐘前` → `now-30min`
   - 可以組合：`三天後十二小時後三十分鐘後二十秒前` → `now+3d+12h+30min-20s`

### 範例

| 輸入 | 處理過程 | 輸出 |
|------|----------|------|
| `明年六月二十號` | `明年`→`sony` + `六月`→`6`→`+5m` + `二十號`→`20`→`+19d` | `sony+5m+19d` |
| `三天前` | `三天`→`3d` + `前`→`-` | `now-3d` |
| `下個月十四號` | `下個月`→`sonm` + `十四號`→`14`→`+13d` | `sonm+13d` |
| `今天下午三點半` | `今天`→`sod+0d` + `下午三點`→`15`→`+15h` + `半`→`+30min` | `sod+0d+15h+30min` |

## 測試

使用 [fish-test](https://github.com/dracula/fish) 進行測試：

```fish
fish tests/test_*.fish
```
